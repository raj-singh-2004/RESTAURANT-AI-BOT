{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Menu Add – API Demo</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Restaurant Menu – API Demo</a>
    <span class="navbar-text ms-auto small" id="nav-user-label"></span>
  </div>
</nav>

<div class="container mb-5">

  <!-- Info / login reminder -->
  <div id="login-warning" class="alert alert-warning d-none">
    You are not logged in. Please
    <a href="/api/accounts/login-demo/" class="alert-link">go to the login page</a>
    and sign in first.
  </div>

  <!-- HEADER -->
  <div class="row">
    <div class="col-12">
      <h4 class="mb-3">Menu Items (for logged-in restaurant owner)</h4>
    </div>
  </div>

  <!-- ROW: table + refresh button -->
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Existing Items</h5>
      <button class="btn btn-sm btn-outline-primary" id="refresh-menu-btn">
        Refresh
      </button>
    </div>
    <div class="col-12 mt-3">
      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle">
          <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Category</th>
            <th>Price</th>
            <th>Currency</th>
            <th>Available</th>
            <th>Veg</th>
            <th>Updated</th>
          </tr>
          </thead>
          <tbody id="menu-table-body">
          <tr>
            <td colspan="8" class="text-center text-muted">
              Loading...
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ROW: create form -->
  <div class="row">
    <div class="col-12 col-lg-8">
      <div class="card">
        <div class="card-header">
          Create New Menu Item
        </div>
        <div class="card-body">
          <form id="menu-create-form" class="row g-3">
            <div class="col-md-6">
              <label for="menu-name" class="form-label">Name *</label>
              <input type="text" class="form-control" id="menu-name" required>
            </div>

            <div class="col-md-6">
              <label for="menu-category" class="form-label">Category</label>
              <input type="text" class="form-control" id="menu-category" placeholder="e.g. Main Course">
            </div>

            <div class="col-md-4">
              <label for="menu-price" class="form-label">Price *</label>
              <input type="number" step="0.01" class="form-control" id="menu-price" required>
            </div>

            <div class="col-md-4">
              <label for="menu-currency" class="form-label">Currency</label>
              <select class="form-select" id="menu-currency">
                <option value="INR" selected>INR</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label d-block">Flags</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="menu-available" checked>
                <label class="form-check-label" for="menu-available">Available</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="menu-veg" checked>
                <label class="form-check-label" for="menu-veg">Veg</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="menu-vegan">
                <label class="form-check-label" for="menu-vegan">Vegan</label>
              </div>
            </div>

            <div class="col-12">
              <label for="menu-description" class="form-label">Description</label>
              <textarea class="form-control" id="menu-description" rows="2"></textarea>
            </div>

            <div class="col-12">
              <label for="menu-ingredients" class="form-label">
                Ingredients (comma separated)
              </label>
              <input
                type="text"
                class="form-control"
                id="menu-ingredients"
                placeholder="e.g. paneer, tomato, onion"
              >
            </div>

            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                Create Menu Item
              </button>
              <span id="menu-form-status" class="ms-2 small"></span>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- small note card -->
    <div class="col-12 col-lg-4 mt-3 mt-lg-0">
      <div class="card">
        <div class="card-body">
          <h6>Notes</h6>
          <ul class="small mb-0">
            <li>Login first at <code>/api/accounts/login-demo/</code>.</li>
            <li>This page uses the JWT stored in <code>localStorage</code>.</li>
            <li>API uses <code>MenuItemViewSet</code> with <code>IsAuthenticated</code>.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // === CONFIG: must match your backend routes ===
  const MENU_API_URL = "/api/menu/menu-items/";

  const ACCESS_TOKEN_KEY = "rb_access_token";
  const REFRESH_TOKEN_KEY = "rb_refresh_token";
  const USER_KEY = "rb_user";

  // CSRF helper (needed only if also using SessionAuthentication; harmless otherwise)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  // === AUTH HELPERS ===
  function getAccessToken() {
    return localStorage.getItem(ACCESS_TOKEN_KEY);
  }

  function getUserFromStorage() {
    const raw = localStorage.getItem(USER_KEY);
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (e) {
      return null;
    }
  }

  function getAuthHeaders(extra = {}) {
    const token = getAccessToken();
    const headers = {
      "Accept": "application/json",
      ...extra,
    };
    if (token) {
      headers["Authorization"] = "Bearer " + token;
    }
    return headers;
  }

  function updateNavUserLabel() {
    const label = document.getElementById("nav-user-label");
    const user = getUserFromStorage();
    const token = getAccessToken();
    if (token && user) {
      const name = user.username || user.email || "user";
      label.textContent = "Logged in as " + name;
    } else {
      label.textContent = "Not logged in";
    }
  }

  function showLoginWarningIfNeeded() {
    const warning = document.getElementById("login-warning");
    if (!getAccessToken()) {
      warning.classList.remove("d-none");
    } else {
      warning.classList.add("d-none");
    }
  }

  // === MENU: list items ===
  async function loadMenu() {
    const tbody = document.getElementById("menu-table-body");
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>';

    if (!getAccessToken()) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">No token found. Please login first.</td></tr>';
      showLoginWarningIfNeeded();
      return;
    }

    try {
      const res = await fetch(MENU_API_URL, {
        method: "GET",
        headers: getAuthHeaders(),
      });

      if (res.status === 401) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Unauthorized (401). Token invalid or expired. Please login again.</td></tr>';
        showLoginWarningIfNeeded();
        return;
      }

      if (!res.ok) {
        throw new Error("Failed to load menu: " + res.status);
      }

      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.results || []);

      if (!items.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No menu items found.</td></tr>';
        return;
      }

      tbody.innerHTML = "";
      items.forEach((item) => {
        const price = item.price ?? "";
        const currency = item.currency ?? "INR";
        const category = item.category ?? "";
        const available = item.available ? "Yes" : "No";
        const veg = item.is_vegetarian ? "Veg" : "Non-veg";
        const updated = item.updated_at ? new Date(item.updated_at).toLocaleString() : "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.id}</td>
          <td>${item.name}</td>
          <td>${category}</td>
          <td>${price}</td>
          <td>${currency}</td>
          <td>${available}</td>
          <td>${veg}</td>
          <td>${updated}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="8" class="text-danger text-center">Error loading menu</td></tr>';
    }
  }

  // === MENU: create item ===
  async function handleCreateMenuItem(event) {
    event.preventDefault();

    const statusEl = document.getElementById("menu-form-status");
    statusEl.textContent = "";
    statusEl.className = "ms-2 small";

    if (!getAccessToken()) {
      statusEl.textContent = "Please login first.";
      statusEl.classList.add("text-danger");
      showLoginWarningIfNeeded();
      return;
    }

    const name = document.getElementById("menu-name").value.trim();
    const category = document.getElementById("menu-category").value.trim();
    const price = document.getElementById("menu-price").value;
    const currency = document.getElementById("menu-currency").value;
    const description = document.getElementById("menu-description").value.trim();
    const ingredientsRaw = document.getElementById("menu-ingredients").value.trim();

    const available = document.getElementById("menu-available").checked;
    const isVegetarian = document.getElementById("menu-veg").checked;
    const isVegan = document.getElementById("menu-vegan").checked;

    if (!name || !price) {
      statusEl.textContent = "Name and price are required.";
      statusEl.classList.add("text-danger");
      return;
    }

    const payload = {
      name: name,
      description: description,
      price: price,
      available: available,
      category: category,
      currency: currency,
      is_vegetarian: isVegetarian,
      is_vegan: isVegan,
      ingredients: ingredientsRaw, // adjust to your serializer
    };

    try {
      const res = await fetch(MENU_API_URL, {
        method: "POST",
        headers: getAuthHeaders({
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        }),
        body: JSON.stringify(payload),
      });

      if (res.status === 401) {
        statusEl.textContent = "Unauthorized (401). Token invalid or expired. Please login again.";
        statusEl.classList.add("text-danger");
        showLoginWarningIfNeeded();
        return;
      }

      if (!res.ok) {
        const text = await res.text();
        console.error("Create failed:", res.status, text);
        statusEl.textContent = "Error creating item";
        statusEl.classList.add("text-danger");
        return;
      }

      statusEl.textContent = "Created successfully ✅";
      statusEl.classList.add("text-success");

      document.getElementById("menu-create-form").reset();
      document.getElementById("menu-available").checked = true;
      document.getElementById("menu-veg").checked = true;

      loadMenu();
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error creating item";
      statusEl.classList.add("text-danger");
    }
  }

  // === Init ===
  document.addEventListener("DOMContentLoaded", () => {
    updateNavUserLabel();
    showLoginWarningIfNeeded();

    document
      .getElementById("refresh-menu-btn")
      .addEventListener("click", loadMenu);

    document
      .getElementById("menu-create-form")
      .addEventListener("submit", handleCreateMenuItem);

    // Auto-load if already have token
    if (getAccessToken()) {
      loadMenu();
    } else {
      const tbody = document.getElementById("menu-table-body");
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">No token found. Please login first.</td></tr>';
    }
  });
</script>

</body>
</html>
