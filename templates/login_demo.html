{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login â€“ Restaurant Admin</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Restaurant Admin Login</a>
  </div>
</nav>

<div class="container mt-4 mb-5">

  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">

      <div class="text-center mb-3">
        <h3 class="fw-semibold mb-1">Sign in</h3>
        <p class="text-muted small mb-0">
          Use your Django username and password.
        </p>
      </div>

      <!-- Logged-in banner (based on localStorage) -->
      <div id="welcome-user-banner" class="alert alert-success py-2 px-3 small d-none mb-3"></div>

      <div class="card shadow-sm border-0">
        <div class="card-body">
          <!-- ðŸ‘‡ method="post" + csrf_token so Django sets csrftoken cookie -->
          <form id="login-form" method="post" novalidate>
            {% csrf_token %}
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input
                type="text"
                class="form-control"
                id="username"
                required
              >
            </div>

            <div class="mb-2">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                class="form-control"
                id="password"
                required
              >
            </div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="show-password">
              <label class="form-check-label small" for="show-password">
                Show password
              </label>
            </div>

            <button type="submit" class="btn btn-primary w-100" id="login-btn">
              Login
            </button>
            <div class="mt-2">
              <span id="login-status" class="small"></span>
            </div>
          </form>

          <!-- If already logged in (tokens in localStorage), quick link to menu page -->
          <div id="goto-menu-wrapper" class="mt-3 d-none">
            <a href="/api/menu/demo/" class="btn btn-outline-success w-100 btn-sm">
              Go to Menu API Demo
            </a>
          </div>
        </div>
      </div>

      <div class="card mt-3 shadow-sm border-0">
        <div class="card-header">
          <span class="fw-semibold">Response / Debug</span>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small text-muted">Inspect API response or stored tokens.</span>
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-secondary" id="show-tokens-btn">
                Show tokens
              </button>
              <button type="button" class="btn btn-outline-danger" id="clear-tokens-btn">
                Clear tokens
              </button>
            </div>
          </div>
          <pre id="login-result" class="small mb-0 text-wrap" style="white-space: pre-wrap;"></pre>
        </div>
      </div>

    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ðŸ”§ Adjust this if your login API URL is different
  const LOGIN_API_URL = "/api/accounts/login/";
  const MENU_DEMO_URL = "/api/menu/demo/";

  const form = document.getElementById("login-form");
  const loginBtn = document.getElementById("login-btn");
  const statusEl = document.getElementById("login-status");
  const resultEl = document.getElementById("login-result");
  const welcomeBanner = document.getElementById("welcome-user-banner");
  const gotoMenuWrapper = document.getElementById("goto-menu-wrapper");

  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const showPasswordCheckbox = document.getElementById("show-password");

  const showTokensBtn = document.getElementById("show-tokens-btn");
  const clearTokensBtn = document.getElementById("clear-tokens-btn");

  // ðŸ”¹ Get CSRF cookie from Django
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie("csrftoken");
  console.log("CSRFTOKEN from cookie:", csrftoken);

  // Toggle password visibility
  showPasswordCheckbox.addEventListener("change", function () {
    passwordInput.type = this.checked ? "text" : "password";
  });

  function refreshWelcomeFromStorage() {
    const userJson = localStorage.getItem("rb_user");
    const access = localStorage.getItem("rb_access_token");

    if (!userJson || !access) {
      welcomeBanner.classList.add("d-none");
      welcomeBanner.textContent = "";
      gotoMenuWrapper.classList.add("d-none");
      return;
    }

    try {
      const user = JSON.parse(userJson);
      const name = user.username || user.email || "user";
      welcomeBanner.textContent = `Currently logged in (from storage): ${name}`;
      welcomeBanner.classList.remove("d-none");
      gotoMenuWrapper.classList.remove("d-none");
    } catch (e) {
      welcomeBanner.classList.add("d-none");
      welcomeBanner.textContent = "";
      gotoMenuWrapper.classList.add("d-none");
    }
  }

  form.addEventListener("submit", async function (event) {
    event.preventDefault();

    statusEl.textContent = "";
    statusEl.className = "small";
    resultEl.textContent = "";

    const username = usernameInput.value.trim();
    const password = passwordInput.value;

    if (!username || !password) {
      statusEl.textContent = "Username and password are required.";
      statusEl.classList.add("text-danger");
      return;
    }

    loginBtn.disabled = true;
    statusEl.textContent = "Logging in...";
    statusEl.classList.remove("text-danger", "text-success");

    try {
      const res = await fetch(LOGIN_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-CSRFToken": csrftoken,   // ðŸ”‘ send CSRF header
        },
        credentials: "same-origin",    // ðŸ”‘ send cookies for same-origin
        body: JSON.stringify({ username, password }),
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        data = { raw: text };
      }

      if (!res.ok) {
        statusEl.textContent = data.detail || "Invalid credentials.";
        statusEl.classList.add("text-danger");
        resultEl.textContent = JSON.stringify(data, null, 2);
        // clear any old tokens on failure
        localStorage.removeItem("rb_access_token");
        localStorage.removeItem("rb_refresh_token");
        localStorage.removeItem("rb_user");
        refreshWelcomeFromStorage();
        return;
      }

      // Expecting: { refresh: "...", access: "...", user: {...} }
      const access = data.access;
      const refresh = data.refresh;
      const user = data.user;

      // Store tokens for later API calls (menu demo page will use them)
      localStorage.setItem("rb_access_token", access);
      localStorage.setItem("rb_refresh_token", refresh);
      localStorage.setItem("rb_user", JSON.stringify(user));

      statusEl.textContent = "Login successful âœ… Redirecting to menu page...";
      statusEl.classList.add("text-success");

      resultEl.textContent = JSON.stringify(data, null, 2);
      refreshWelcomeFromStorage();

      // ðŸ” Redirect to the Menu API Demo page after a short delay
      setTimeout(() => {
        window.location.href = MENU_DEMO_URL;
      }, 800);

    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error calling login API.";
      statusEl.classList.add("text-danger");
      resultEl.textContent = String(err);
    } finally {
      loginBtn.disabled = false;
    }
  });

  // Show tokens debug
  showTokensBtn.addEventListener("click", function () {
    const access = localStorage.getItem("rb_access_token") || null;
    const refresh = localStorage.getItem("rb_refresh_token") || null;
    const userStr = localStorage.getItem("rb_user");
    let user = null;
    try {
      user = userStr ? JSON.parse(userStr) : null;
    } catch (e) {
      user = null;
    }
    const debug = { access, refresh, user };
    resultEl.textContent = JSON.stringify(debug, null, 2);
  });

  // Clear tokens
  clearTokensBtn.addEventListener("click", function () {
    localStorage.removeItem("rb_access_token");
    localStorage.removeItem("rb_refresh_token");
    localStorage.removeItem("rb_user");
    statusEl.textContent = "Tokens cleared from storage.";
    statusEl.className = "small text-warning";
    resultEl.textContent = "";
    refreshWelcomeFromStorage();
  });

  // On first load, show banner & button if tokens already exist
  refreshWelcomeFromStorage();
</script>

</body>
</html>
